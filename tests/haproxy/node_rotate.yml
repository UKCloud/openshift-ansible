# This file sets environment variables needed to run openstack commands on the bastion and then brings down the master nodes in turn, waiting until the last one comes up to bring down the next.
- hosts: localhost
  environment:
    OS_AUTH_URL: "{{ openshift_cloudprovider_openstack_auth_url }}"
    OS_TENANT_ID: "{{ osTenantId }}"
    OS_TENANT_NAME: "{{ osTenantName }}"
    OS_USERNAME: "{{ openstackOpenshiftUsername }}"
    OS_PASSWORD: "{{ openstackOpenshiftPassword }}"
  
  tasks:
  - name: reboot master-0
    shell: nova reboot --hard master-0.{{ localDomainSuffix }}

  - pause:
      seconds: 40

  - name: Get status of master-0
    shell: oc get node | grep master-0 | awk '{ print $2 }' | cut -d , -f 1
    register: master0
    until: master0.stdout == "Ready"
    delay: 5
    retries: 5

  - name: reboot master-1
    shell: nova reboot --hard master-1.{{ localDomainSuffix }}  

  - pause:
      seconds: 40
 
  - name: Get status of master-1
    shell: oc get node | grep master-1 | awk '{ print $2 }' | cut -d , -f 1
    register: master1
    until: master1.stdout == "Ready"
    delay: 5
    retries: 5

  - name: reboot master-2
    shell: nova reboot --hard master-2.{{ localDomainSuffix }}

  - pause:
      seconds: 40

  - name: Get status of master-2
    shell: oc get node | grep master-2 | awk '{ print $2 }' | cut -d , -f 1
    register: master2
    until: master2.stdout == "Ready"
    delay: 5
    retries: 5



