- name: Create patch directory on all hosts to store package lists
  file:
    path: /home/cloud-user/patching
    state: directory
    owner: cloud-user
    mode: 0755

- name: Write output of rpm -qa to file on all hosts
  shell: rpm -qa | sort > /home/cloud-user/patching/rpm-list-"{{ ansible_date_time.date }}"

- include_tasks: patch-lbs.yml

- include_tasks: patch-masters.yml
  vars:
    master_hostname: "{{ groups.masters[0] }}"
    master_ip:  "{{ hostvars[groups['masters'][0]]['openshift_ip'] }}"
    command_master: "{{ groups.masters[1] }}"

- include_tasks: patch-masters.yml
  vars:
    master_hostname: "{{ groups.masters[1] }}"
    master_ip:  "{{ hostvars[groups['masters'][1]]['openshift_ip'] }}"
    command_master: "{{ groups.masters[2] }}"

- include_tasks: patch-masters.yml
  vars:
    master_hostname: "{{ groups.masters[2] }}"
    master_ip:  "{{ hostvars[groups['masters'][2]]['openshift_ip'] }}"
    command_master: "{{ groups.masters[0] }}"

- name: Create worker patch file off template
  template:
    src: /usr/share/ansible/openshift-deployment-ansible/roles/patching/templates/workers.j2
    dest: /usr/share/ansible/openshift-deployment-ansible/roles/patching/tasks/patch-workers.yml
    force: yes
  when: inventory_hostname == 'localhost'

- include_tasks: patch-workers.yml
