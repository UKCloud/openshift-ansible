- name: Generate Portworx cluster UUID
  command: /usr/bin/uuidgen | tr '[:upper:]' '[:lower:]'
  register: portworx_cluster_uuid

- name: Retrieve Kubernetes version
  shell: "/var/usrlocal/bin/kubectl version --short | /usr/bin/awk -Fv '/Server Version: / {print $3}'"
  register: kubernetes_version

- name: Add Portworx service accounts to privileged SCC
  shell: |
    /usr/local/bin/oc adm policy add-scc-to-user privileged system:serviceaccount:kube-system:px-account
    /usr/local/bin/oc adm policy add-scc-to-user privileged system:serviceaccount:kube-system:portworx-pvc-controller-account
    /usr/local/bin/oc adm policy add-scc-to-user privileged system:serviceaccount:kube-system:px-lh-account
    /usr/local/bin/oc adm policy add-scc-to-user anyuid system:serviceaccount:kube-system:px-lh-account
    /usr/local/bin/oc adm policy add-scc-to-user anyuid system:serviceaccount:default:default
    /usr/local/bin/oc adm policy add-scc-to-user privileged system:serviceaccount:kube-system:px-csi-account

- name: Create docker registry credentials secret
  command: /usr/local/bin/oc create secret docker-registry pwx-regcred --docker-server='{{ registryUrl }}'' --docker-username='{{ registryUser }}'' --docker-password='{{ registryPassword }}'' --docker-email='openshift@ukcloud.com' -n kube-system

- name: Create alertmanager file from template
  template:
    src: templates/portworx-alertmanager.j2
    dest: /home/cloud-user/alertmanager.yaml

- name: Create alertmanager secret
  command: /usr/local/bin/oc create secret generic alertmanager-portworx --from-file=/home/cloud-user/alertmanager.yaml -n kube-system

- name: Remove alertmanager file
  file:
    path: /home/cloud-user/alertmanager.yaml
    state: absent

- name: Create Portworx spec from template
  template:
    src: templates/portworx.j2
    dest: /home/cloud-user/portworx.yaml

- name: Deploy Portworx
  command: /usr/local/bin/oc create -f /home/cloud-user/portworx.yaml

- name: Create Portworx storage class spec from template
  template:
    src: templates/portworx-storage-classes.j2
    dest: /home/cloud-user/portworx-storage-classes.yaml

- name: Create Portworx storage classes
  command: /usr/local/bin/oc create -f /home/cloud-user/portworx-storage-classes.yaml

- name: Remove Portworx storage classes file
  file:
    path: /home/cloud-user/portworx-storage-classes.yaml
    state: absent
