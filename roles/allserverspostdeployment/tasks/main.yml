- name: Configure iptables on infra nodes for extra gateway
  iptables:
    chain: OS_FIREWALL_ALLOW
    protocol: tcp
    ctstate: NEW
    destination_port: "{{ item }}"
    jump: ACCEPT
    comment: Open port for extra gateway router
  with_items:
    - 7080
    - 7443
  when: extra_gateway_vip is defined and inventory_hostname in groups.nodes_infra
  
- name: Make private-router iptables rules persistent
  blockinfile:
    path: /etc/sysconfig/iptables
    insertbefore: '^COMMIT'
    marker: "# {mark} private-router rules"
    block: |
      -A OS_FIREWALL_ALLOW -p tcp -m tcp --dport 7080 -m comment --comment "Open port for extra gateway router" -m conntrack --ctstate NEW -j ACCEPT
      -A OS_FIREWALL_ALLOW -p tcp -m tcp --dport 7443 -m comment --comment "Open port for extra gateway router" -m conntrack --ctstate NEW -j ACCEPT
  when: extra_gateway_vip is defined and inventory_hostname in groups.nodes_infra 

- name: Block root login via SSH to all instances
  replace:
    path: /etc/ssh/sshd_config
    regexp: '^.?PermitRootLogin.*$'
    replace: 'PermitRootLogin no'
    backup: yes

- name: Reload sshd service to apply changes
  systemd:
    state: reloaded
    name: sshd

- name: Set journal size to 3G
  replace:
    path: /etc/systemd/journald.conf
    regexp: '^\sSystemMaxUse=.*'
    replace: ' SystemMaxUse=3G'
  when: inventory_hostname in groups.nodes and inventory_hostname not in groups.masters

- name: Restart systemd-journald service to implement journal size change
  service:
    name: systemd-journald
    state: restarted
  when: inventory_hostname in groups.nodes and inventory_hostname not in groups.masters

- name: Retrieve pods on Portworx storage networks
  shell: /usr/local/bin/oc get pods -o wide --all-namespaces | awk 'BEGIN { OFS = " -n " } /10.254.253.|10.254.254./ {print $2, $1}'
  register: portworx_storage_network_pods
  when: inventory_hostname in groups.masters[0]

- name: Delete pods on Portworx storage networks
  command: /usr/local/bin/oc delete pod {{ item }}
  with_items: "{{ portworx_storage_network_pods.stdout_lines }}"
  loop_control:
    pause: 15
  when: inventory_hostname in groups.masters[0] and deploy_portworx_storage

- name: Pause to allow deleted pods to come back before moving on
  pause:
    seconds: 15
  when: deploy_portworx_storage
 
- include_tasks: squid-whitelist.yml
  when: multinetwork

- include_tasks: docker-prune.yml

- include_tasks: squid-showback.yml
  when: multinetwork
